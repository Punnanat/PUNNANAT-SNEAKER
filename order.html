<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบจองคิวรองเท้าสำหรับรุ่นพิเศษ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Sarabun', sans-serif; background: linear-gradient(135deg, #a78bfa 0%, #f0abfc 100%); margin: 0; }
    .order-container { max-width: 500px; margin: 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 8px #0001; padding: 32px 24px; }
    .sneaker-img { display: flex; justify-content: center; margin-bottom: 16px; }
    .sneaker-img img { width: 180px; border-radius: 10px; }
    .meta { margin-bottom: 20px; }
    .meta span { display: block; color: #555; }
    .meta .name { font-size: 1.2em; font-weight: bold; color: #222; margin-bottom: 6px; }
    .meta .price { color: #7c3aed; font-size: 1.1em; }
    .badge { color: #16a34a; font-size: 1em; margin-bottom: 8px; }
    form label { display: block; margin-top: 12px; color: #333; }
    form input, form select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
    .order-btn { width: 100%; margin-top: 20px; padding: 12px; background: #7c3aed; color: #fff; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; }
    .order-btn:hover { background: #5b21b6; }
    .success { color: #1abc9c; text-align: center; margin-top: 12px; }
    .error { color: #e74c3c; text-align: center; margin-top: 12px; }
    .logout-btn { position: fixed; top: 20px; right: 30px; background: #e74c3c; color: #fff; border: none; border-radius: 8px; padding: 8px 18px; font-size: 1em; cursor: pointer; }
  </style>
</head>
<body>

  <button class="logout-btn" onclick="logout()">ออกจากระบบ</button>
  <div class="order-container">
    <div class="sneaker-img"><img id="productImg" src="" alt=""></div>
    <div class="meta">
      <span class="name" id="productName"></span>
      <span id="productCode"></span>
      <span id="productRelease"></span>
      <span id="productStock"></span>
      <span class="price" id="productPrice"></span>
    </div>
    <div class="badge"><i>✔ เปิดให้จองแล้ว</i></div>
    <div class="badge"><i>" กรุณากรอกข้อมูลให้ครบถ้วน"</i></div>
    <div id="clockDisplay" style="text-align:center; font-weight:bold; color:#7c3aed; margin-bottom:12px;"></div>

    <form id="orderForm">
      <label>ชื่อ-นามสกุล</label>
      <input type="text" id="customerName" required>
      <label>เบอร์โทรศัพท์</label>
      <input type="tel" id="customerPhone" required>
      <label>อีเมล</label>
      <input type="email" id="customerEmail" required>
      <label>บ้านเลขที่ / หมู่ / ถนน</label>
      <input type="text" id="houseNumber" required>
      <label>ตำบล</label>
      <input type="text" id="subDistrict" required>
      <label>อำเภอ</label>
      <input type="text" id="district" required>
      <label>จังหวัด</label>
      <input list="provinceList" id="province" required placeholder="พิมพ์ชื่อจังหวัด">
      <datalist id="provinceList">
        <option value="กรุงเทพมหานคร">
        <option value="อุบลราชธานี">
        <option value="เชียงใหม่">
        <option value="ขอนแก่น">
        <option value="ภูเก็ต">
      </datalist>
      <label>รหัสไปรษณีย์</label>
      <input type="text" id="zipcode" maxlength="5" required placeholder="กรอก 5 หลัก">
      <label>เลือกไซส์รองเท้า (US)</label>
      <select id="shoeSize" required>
        <option value="">-- กรุณาเลือกไซส์ --</option>
        <option value="7">7</option>
        <option value="7.5">7.5</option>
        <option value="8">8</option>
        <option value="8.5">8.5</option>
        <option value="9">9</option>
        <option value="9.5">9.5</option>
        <option value="10">10</option>
        <option value="10.5">10.5</option>
        <option value="11">11</option>
        <option value="11.5">11.5</option>
        <option value="12">12</option>
      </select>
      <button type="submit" class="order-btn">เข้าคิวจอง</button>
    </form>
    <div class="success" id="successMsg"></div>
    <div class="error" id="errorMsg"></div>
  </div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbz2exmUUlPkLF99b7DC1KmYISXaY_DdhQZUkQkEy-atK3Um2jL7s9h-Ba-eRh3x3eqH/exec";

    window.onload = function() {
      if (!localStorage.getItem('currentUser')) {
        window.location.href = "login.html";
      }

      function logout(){
        localStorage.removeItem('currentUser');
        window.location.href = "https://punnanat.github.io/PUNNANAT-SNEAKER/";
      }

      function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString('th-TH', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        document.getElementById('clockDisplay').innerText = "เวลา: " + time;
      }
      setInterval(updateClock, 1000);
      updateClock();

      const products = {
      blackcat: {
        name: 'Nike Air Jordan 4 "Black Cat" 2024',
        code: "CU1110-010",
        price: 8900,
        img: "https://www.sneakerfiles.com/wp-content/uploads/2024/08/air-jordan-4-rm-black-cat-FQ7939-004-release-info-1024x725.jpg",
        release: "25 กันยายน 2025",
        stock: 4
      },
      travis1: {
        name: 'Nike Air Jordan 1 Low OG "Travis Scott"',
        code: "DM7866-162",
        price: 15900,
        img: "https://2app.kicksonfire.com/kofapp/upload/events_images/ipad_travis-scott-x-air-jordan-1-low-og-black-olive-0.png",
        release: "25 กันยายน 2025",
        stock: 3
      },
      yeezy: {
        name: 'adidas Yeezy Boost 350 V2 "Zebra"',
        code: "CP9654",
        price: 12500,
        img: "https://www.sneakerfiles.com/wp-content/uploads/2018/10/adidas-yeezy-boost-350-v2-zebra-restock.jpg",
        release: "25 กันยายน 2025",
        stock: 3
      },
      offwhite: {
        name: 'Nike Air Presto Off-White',
        code: "AA3830-001",
        price: 32000,
        img: "https://www.kickgame.com/cdn/shop/products/Nike-Air-Presto-OW-AA3830-100-White_1.png?v=1658243604",
        release: "25 กันยายน 2025",
        stock: 2
      }
    };

    const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('product');
      const product = products[productId] || products.blackcat;

      document.getElementById('productImg').src = product.img;
      document.getElementById('productName').innerText = product.name;
      document.getElementById('productCode').innerText = "รหัส: " + product.code;
      document.getElementById('productRelease').innerText = "วันเปิดขาย: " + product.release;
      document.getElementById('productStock').innerText = "จำนวน: " + product.stock + " คู่";
      document.getElementById('productPrice').innerText = "฿" + product.price.toLocaleString();

      document.getElementById('zipcode').addEventListener('input', function () {
        this.value = this.value.replace(/\D/g, '').slice(0, 5);
      });

      async function checkStock() {
        const response = await fetch(SHEET_URL + `?checkStock=true&code=${product.code}`);
        const data = await response.json();
        if (data.count >= product.stock) {
          document.querySelector('.badge').innerHTML = '<i style="color:red;">❌ เต็มแล้ว</i>';
          const btn = document.querySelector('.order-btn');
          btn.disabled = true;
          btn.style.background = '#ccc';
          btn.innerText = 'เต็มแล้ว';
        }
      }
      checkStock();

      document.getElementById('orderForm').addEventListener('submit', function(e){
  e.preventDefault();

  const name = document.getElementById('customerName').value.trim();
  const phone = document.getElementById('customerPhone').value.trim();
  const email = document.getElementById('customerEmail').value.trim();
  const province = document.getElementById('province').value.trim();
  const zipcode = document.getElementById('zipcode').value.trim();
  const size = document.getElementById('shoeSize').value;
  const houseNumber = document.getElementById('houseNumber').value.trim();
  const subDistrict = document.getElementById('subDistrict').value.trim();
  const district = document.getElementById('district').value.trim();

  const successMsg = document.getElementById('successMsg');
  const errorMsg = document.getElementById('errorMsg');

  // เคลียร์ข้อความก่อนเริ่ม
  successMsg.innerHTML = '';
  errorMsg.innerText = '';

  // ตรวจสอบความถูกต้องของข้อมูล
  if (!/^\d{5}$/.test(zipcode)) {
    errorMsg.innerText = 'กรุณากรอกรหัสไปรษณีย์ให้ถูกต้อง (5 หลัก)';
    return;
  }

  if (!name || !phone || !email || !province || !size || !houseNumber || !subDistrict || !district) {
    errorMsg.innerText = 'กรุณากรอกข้อมูลให้ครบถ้วน';
    return;
  }

  const now = new Date();
  const date = now.toISOString().split('T')[0];
  const time = now.toLocaleTimeString('th-TH', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });

  // ส่งข้อมูลไปยัง Google Apps Script
  fetch(SHEET_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      name, email, phone, province, zipcode, size,
      product: product.name,
      code: product.code,
      date, time,
      houseNumber, subDistrict, district
    })
  })
  .then(res => res.text())
  .then(txt => {
    if (txt.toLowerCase().includes("success")) {
      successMsg.innerHTML = `
        ✅ สั่งจองสำเร็จ!<br>
        <strong>ชื่อ:</strong> ${name}<br>
        <strong>รุ่น:</strong> ${product.name}<br>
        <strong>ไซส์:</strong> ${size}<br>
        <strong>วันที่:</strong> ${date}<br>
        <strong>เวลา:</strong> ${time}
      `;
      document.getElementById('orderForm').reset();
      checkStock(); // อัปเดตสถานะสต็อกหลังจอง
    } else {
      errorMsg.innerText = "❌ เกิดข้อผิดพลาด กรุณาลองใหม่";
    }
  })
  .catch(err => {
    errorMsg.innerText = "❌ ไม่สามารถเชื่อมต่อได้: " + err.message;
  });
});

    };
  </script>
</body>
</html>